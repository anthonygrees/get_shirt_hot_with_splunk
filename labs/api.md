# Splunk API Commands - Cheat Sheet
  
[Back to the Lab Index](../README.md#get-shirt-hot-with-splunk)
  
## About the API
The splunk cloud admin api is intended to empower the customer admins to manage their Splunk Cloud Stacks. There are 2 different API's depending on your Splunk experience:  
 - Victoria Experience uses ACS
 - Classic Experience uses DMC
   
The following diagram shows the ACS architecture on the CO2 framework.  
  
![Architecture](/images/api/acs_architecture.png)
  
## ACS
The ACS (Admin Config Service) is an external facing service that will actually handle the API requests from the Splunk Cloud Admins. The service will in-turn translate the calls to the various internal systems to honour the admins requests as required. It works for SplunkCloud versions on Victoria experience. You can determine your SplunkCloud experience [here](https://docs.splunk.com/Documentation/SplunkCloud/8.2.2105/Admin/Experience).
  
## DMC
The DMC is the Distributed Management Console and provides a set of API commands. It works for SplunkCloud versions on Classic experience.
  
## C02 Framework
co2 is the existing framework that manages the infrastructure that runs the splunk cloud stacks. co2 is based on the kubernetes operator model, where every stack is tracked by the Stacks (CRD) Custom Resource Definition. The splunk-cloud-operator then keeps watching these CRDs and updates the splunk stacks and their infrastructure as required to match the requested specifications in their respective CRDs.  
  
  
## Table of Contents
  
| API Section           | Link         |
| ------------- |:------------:|
|            |          |
|  1. Set up the ACS API  |   [Link](../labs/api.md#1-set-up-the-acs-api)       |
|            |          |
| 2. Manage HTTP Event Collector (HEC) tokens |          |
| 2a. HEC - DMC API for Classic Experience   | [Link](../labs/api.md#21-hec---dmc-api-commands-classic) |
| 2b. HEC - ACS API for Victoria Experience  | [Link](../labs/api.md#22-hec---acs-api-commands-victoria-experience) |
|            |          |
|  3. Configure IP allow lists for Splunk Cloud | [Link](../labs/api.md#3-configure-ip-allow-lists-for-splunk-cloud)     |
|            |          |
|  4. Manage Indexes on SplunkCloud  | [Link](../labs/api.md#4-manage-indexes) |
|            |          |
|  5. Install Private App on SplunkCloud  | [Link](../labs/api.md#5-install-private-app-on-splunkcloud) |
|            |          |
|  6. Manage App's on SplunkCloud  | [Link](../labs/api.md#6-manage-apps-on-splunkcloud) |
  
  
  
### 1. Set up the ACS API
##### 1a. Retrieve the ACS Open API 3.0 specification.  
ACS provides an OpenAPI 3.0 specification that includes all parameters, response codes, and other meta data that you need to send requests to the ACS API endpoint.  
  
To retrieve the ACS Open API 3.0 specification, send an HTTP GET request to:  
```
https://admin.splunk.com/service/info/specs/v1/openapi.json
```
  
You can view a `JSON` formatted verion [here](https://github.com/anthonygrees/get_shirt_hot_with_splunk/blob/main/labs/splunk_openapi_v1.json).
  
##### 1b. Generate an authentication token. 
The ACS API accepts a SAML authentication token. You can generate this token in the Splunk Cloud UI. If your Splunk Cloud environment does not support SAML, you can use local accounts as an alternate authentication method.  
  
To generate a token in Splunk Cloud:  
 - In Splunk Web, click Settings > Token > Enable Token Authentication > New Token.  
 - Configure the new token. Set an expiration time that meets your organization's needs. An expiration time of 60d fits most use cases.  
 - Copy/paste your token into your API client or save for use in curl requests.  
 - Set up API client (optional)  
  
When setting up an API client, such as Postman, specify the following parameters:  
 - {baseURL}: The base URL of the ACS API (https://admin.splunk.com).  
 - {stack}: The URL prefix of your Splunk Cloud deployment (e.g. csms-2io6tw-47150)   
 - {feature}: The feature to which IP allow list requests apply.  
 - {token}: The token generated by Splunk Cloud. See Generate an authentication token.  
  
When using the curl command, you must pass the above parameters with the ACS API request.  
  
  
### 2. HEC - Manage HTTP Event Collector (HEC) tokens
  
##### 2.1. HEC - DMC API Commands (Classic)
The DMC is the Distributed Management Console and provides a set of API commands.
  
  
###### 2.1a Ensure the DMC API is available for use.  
```bash
curl -k -u admin:your_password https://CUSTOMER_NAME.splunkcloud.com:8089/services/dmc/info
```
If you get a response saying the DMC servive is ```enabled``` you can use the commands below.  
  
###### 2.1b Create HEC Token. 
```bash
curl -k -u admin:your_password -X POST -H "Content-Type: application/json" https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http -d '{"name":"Anthony1", "description":"token created via REST", "index":"main", "sourcetype":"json_no_timestamp"}' 
```
  
###### 2.1c List all HEC Tokens
```bash
curl -k -u admin:your_password https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http
```
  
###### 2.1d List HEC Token by Name
```bash
curl -k -u admin:your_password https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http/Anthony1
```
  
###### 2.1e Disable HEC Token
```bash
curl -k -u admin:your_password -H "Content-Type: application/json" https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http/Anthony1 -d '{"disabled":"true"}'
```
  
###### 2.1f Enable HEC Token
```bash
curl -k -u admin:your_password -H "Content-Type: application/json" https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http/Anthony1 -d '{"disabled":"false"}'
```
  
###### 2.1g Update HEC Token
```bash
curl -k -u admin:your_password -H "Content-Type: application/json" https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http/Anthony1 -d '{"description":"Updated Description"}'
```
  
###### 2.1h Delete HEC Token
```bash
curl -k -u admin:your_password -X DELETE https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http/Anthony1
```
  
  
  
##### 2.2. HEC - ACS API Commands (Victoria Experience)
Admin config service (ACS) commands to support operations on HEC via service.
  
###### 2.2a Add HEC Token.  
```bash
curl --location --request POST 'admin.splunk.com/:stack/adminconfig/v1/inputs/http-event-collectors' \
--header 'Authorization: Bearer <token>' \
--data-raw '{
    “name” : “tokenname”,
    "defaultIndex": "idx",
    "defaultSource": "default_source",
    "defaultHost": "somehost.com",
    "defaultSourceType": "source_type",
    "disabled": false,
    "allowedIndexes": [
        "idx",
        "notidx"
    ]
}'
```
  
###### 2.2b Get HEC Token.  
```bash
curl --location --request GET 'admin.splunk.com/:stack/adminconfig/v1/inputs/http-event-collectors' \
--header 'Authorization: Bearer <token>'
```
  
###### 2.2c Get HEC Name.  
```bash
curl --location --request GET 'admin.splunk.com/:stack/adminconfig/v1/hec/newhectoken' \
--header 'Authorization: Bearer <token>'
```
  
###### 2.2d Delete HEC Name.  
```bash
curl --location --request DELETE 'admin.splunk.com/:stack/adminconfig/v1/inputs/http-event-collectors/:hecname' \
--header 'Authorization: Bearer <token>' \
--data-raw '{}'
```
  
  
### 3. Configure IP allow lists for Splunk Cloud
Splunk Cloud IP allow lists control which IP addresses on your network have access to specified components (features) in your Splunk Cloud deployment. You can use the Splunk Cloud Admin Config Service (ACS) API to add or remove subnets from the allow list and manage access to features in your Splunk Cloud environment programmatically.  
  
##### 3a. Determine IP allow list use case
The ACS API supports several common IP allow list use cases. In each use case, the IP allow list controls access to a particular Splunk Cloud feature. 
  
| Use Case	| Feature Type	| Port	| Description |
| ------------- |:------------:| ------------- |:------------:|
| Search head API access |	search-api |	8089 |	Grants access for customer subnets to Splunk search head api (applies to automated interfaces) |
| HEC access for ingestion |	hec |	443	| Allows customer's environment to send HTTP data to Splunk indexers. |
| Indexer ingestion |	s2s |	9997 |	Allows subnets that include UF or HF to send data to Splunk indexers. |
| SH UI access |	search-ui |	80/443	| Grant explicit access to search head UI in regulated customer environments. |
| IDM UI access |	idm-ui |	443 |	Grant explicit access to IDM UI in regulated customer environments. |
| IDM API |	idm-api |	8089 |	Grant access for add-ons that require an API. (Allows add-ons to send data to Splunk Cloud.) |
  
##### 3b. View current IP Allow list.  
To view the full list of existing subnets for a particular IP allow list feature type, send an HTTP GET request to the following endpoint:  
```bash
{baseUrl}/{stack}/adminconfig/v1/access/{feature}/ipallowlists
```
For example, to view the full list of subnets for the s2s IP allow list feature type, send the following request:  
```bash
curl https://admin.splunk.com/{stack}/adminconfig/v1/access/s2s/ipallowlists
```
The request returns the current allow list subnets for the s2s feature type only. For example:  
  
```bash
{
  "subnets": [
     ": #.0.0.0/24",
     ": #.0.0.0/24",
     ": #.0.10.6/32"
  ]
}
```
  
##### 3c. Add subnets to IP allow list
To add a new subnet to the IP allow list:  
  
Send an HTTP POST request to the ```{feature}/ipallowlists``` endpoint, specifying the subnet that you want to add. For example, to add new subnets to the IP allow list for the s2s feature:  
```bash
curl -X POST 'https://admin.splunk.com/mystack/v1/access/s2s/ipallowlists' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer eyJraWQiOiJzcGx1bmsuc2VjcmV0Iiw...' \
--data-raw '{
"subnets": [
"###.0.0.0/24",
"##.0.10.6/32"
]
}'
```
  
A `200` response code indicates that your request was submitted successfully. Note however that the ACS request process is asynchronous and it can take several minutes for the subnet update to be applied to your Splunk Cloud deployment.  
  
You can check the status of your subnet update request, as follows: 
```bash
curl GET https://admin.splunk.com/{stack}/adminconfig/v1/status
```
ACS returns one of the following status responses:
 - `Ready`  
 - `Pending`  
 - `Failed`  
  
##### 3d. Remove subnets from IP allow list    
To remove a subnet from an IP allow list:  
  
Send an HTTP DELETE request specifying the subnet you want to delete. For example, to remove subnets from the IP allow list for the s2s feature:  
```bash
curl -X DELETE 'https://admin.splunk.com/mystack/adminconfig/v1/access/s2s/ipallowlists' \
--header 'Authorization: Bearer eyJraWQiOiJzcGx1bmsuc2Vj...' \
--header 'Content-Type: application/json' \
--data-raw '{
"subnets": [
"###.0.0.0/24",
"##.0.10.6/32"
]
}'
``` 
  
##### 3e. Confirm IP allow list update.  
To verify that your IP allow list has been updated as expected by POST or DELETE requests:  
  
Send an HTTP GET request specifying the {stack} value (URL prefix of your Splunk Cloud deployment) as follows:
```bash
curl https://admin.splunk.com/mystack/adminconfig/v1/status\
--header 'stack: mystack' \
--header 'Authorization: Bearer eyJraWQiOiJzcGx1bmsuc2...'
```
  
### 4. Manage Indexes
Manage the indexes on the splunk stack. The service will update the k8s custom resource corresponding to the stack and the controller will apply the changes.  
  
```bash
<tenant>/cloudadmin/v1/indexes
```
 - `GET` - List indexes - Idempotent  
 - `POST` - Add a new index, fails if token with the name already exists.  
 - `PUT` - Bulk index updates, where multiple updates can be performed using the same request - Idempotent.  
  
```bash
<tenant>/cloudadmin/v1/indexes/<name>
```
 - `GET` - Describe the index - Idempotent
 - `PUT` - Update an existing index, create one if one does not exist - Idempotent
 - `DELETE` - Delete an index if it exits - Idempotent
  
Definition of an index :  
```json
"spec": {
    "dataType": "event/metrics",
    "maxDataSizeStratergy": "auto",
    "maxDataSize": 0,
    "maxHotBuckets": 0,
    "maxWarmDBCount": 0
  }
```
  
Status of index is returned on a describe/list request that contains the sync status.   
```json
  "status": {
    "status": {
      "state": "SYNC_SUCCESS",
      "errors": [
        "string"
      ]
    }
  }
```
  
### 5. Install Private App on SplunkCloud
ACS lets you manage private (custom) apps on your Splunk Cloud stack. For this example, we will assume you have a well-structured app that is ready for AppInspect validation.  
  
For more information on Splunk AppInspect, see https://dev.splunk.com/enterprise/docs/developapps/testvalidate/appinspect/   
  
This API is a `Beta` and you will need a different `openapi.json` to the one above.  
  
```bash
https://admin.splunk.com/service/info/specs/v2beta1/openapi.json
```
  
You can view a `JSON` formatted verion [here](https://github.com/anthonygrees/get_shirt_hot_with_splunk/blob/main/labs/splunk_openapi_v2beta.json).
  
##### 5a. Authenticate
AppInspect relies on a separate set of credentials that are distinct from your environment. You must provide your Splunk.com credentials to receive a JSON Web Token (JWT) for AppInspect. 
  
```bash
https://api.splunk.com/2.0/rest/login/splunk
```
 - `Username`
 - `Password`
  
##### 5b. Validate the App Package
With AppInspect: Select the app package tar file and set a flag to trigger the automated private app vetting process. 
  
```bash
https://appinspect.splunk.com/v1/app/validate
```
 - `app_package` - Pass in the `tar.gz` of the app.  
 - `included_tags` - Specify `private_app`.  
  
Your response will include:  
```json
{
  "request_id": "cd04hjds-uiasdj-iuhasd-2jkh23",
  "message": "Validation request submissted.",
  "links": [
        {
            "href": "/v1/app/validate/status/cd04hjds-uiasdj-iuhasd-2jkh23",
            "rel": "status"
        
        }
  ]
}
```
  
  
##### 5c. Check the Status of the App Submission
Check the status of your App submission. Your will need the request ID for these subsequent API requests.  
  
  
```bash
https://appinspect.splunk.com/v1/app/report/{{request_id}}
```
  
  
The app package is now officially approved by AppInspect. Please see the output for a validation summary below.  
Your response will include:  
```json
{
  "request_id": "cd04hjds-uiasdj-iuhasd-2jkh23",
  "message": "Validation request submissted.",
  "links": [
        {
            "href": "/v1/app/validate/status/cd04hjds-uiasdj-iuhasd-2jkh23",
            "rel": "status"
        
        }
  ],
  "status": "SUCCESS",
  "info": {
        "error": 0,
        "failure": 0,
        "skipped": 0,
        "manual_check": 0,
        "not_applicable": 68,
        "warning": 1,
        "success": 89
  }
}
```
  
  
### 6. Manage Apps on SplunkCloud
  
  
  
  
[Back to the Lab Index](../README.md#get-shirt-hot-with-splunk)
  
