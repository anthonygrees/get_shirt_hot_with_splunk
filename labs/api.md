# Splunk API Commands
  
[Back to the Lab Index](../README.md#get-shirt-hot-with-splunk)
  
## About the API
The splunk cloud admin api is intended to empower the customer admins to manage their Splunk Cloud Stacks. 
 - Victoria Experience uses ACS
 - Classic Experience uses DMC
   
The following diagram shows the ACS architecture on the CO2 framework.  
  
![Architecture](/images/api/acs_architecture.png)
  
## ACS
The ACS (Admin Config Service) is an external facing service that will actually handle the API requests from the Splunk Cloud Admins. The service will in-turn translate the calls to the various internal systems to honour the admins requests as required. It works for SplunkCloud versions on Victoria experience. You can Determine your SplunkCloud experience [here](https://docs.splunk.com/Documentation/SplunkCloud/8.2.2105/Admin/Experience).
  
## DMC
The DMC is the Distributed Management Console and provides a set of API commands. It works for SplunkCloud versions on Classic experience.
  
## C02 Framework
co2 is the existing framework that manages the infrastructure that runs the splunk cloud stacks. co2 is based on the kubernetes operator model, where every stack is tracked by the Stacks (CRD) Custom Resource Definition. The splunk-cloud-operator then keeps watching these CRDs and updates the splunk stacks and their infrastructure as required to match the requested specifications in their respective CRDs.  
  
  
## API Sections
  
| API Section           | Link         |
| ------------- |:------------:|
|            |          |
|  1. Set up the ACS API  |   [Link](https://github.com/anthonygrees/get_shirt_hot_with_splunk/blob/main/labs/api.md#1-set-up-the-acs-api)       |
|            |          |
|  2. Manage HTTP Event Collector (HEC) tokens |          |
| 2a. HEC - DMC API     | [Link](https://github.com/anthonygrees/get_shirt_hot_with_splunk/blob/main/labs/api.md#dmc-api-commands) |
| 2b. HEC - ACS API    | [Link](https://github.com/anthonygrees/get_shirt_hot_with_splunk/blob/main/labs/api.md#acs-api-commands) |
|            |          |
|  3. Configure IP allow lists for Splunk Cloud         |          |
|            |          |
|  4. Manage Indexes on SplunkCloud          |          |
|            |          |
|  5. Apps          |          |
  
  
  
### 1. Set up the ACS API
1a. Retrieve the ACS Open API 3.0 specification.  
ACS provides an OpenAPI 3.0 specification that includes all parameters, response codes, and other meta data that you need to send requests to the ACS API endpoint.  
  
To retrieve the ACS Open API 3.0 specification, send an HTTP GET request to:  
```
https://admin.splunk.com/service/info/specs/v1/openapi.json
```
  
1b. Generate an authentication token. 
The ACS API accepts a SAML authentication token. You can generate this token in the Splunk Cloud UI. If your Splunk Cloud environment does not support SAML, you can use local accounts as an alternate authentication method.  
  
To generate a token in Splunk Cloud:  
 - In Splunk Web, click Settings > Token > Enable Token Authentication > New Token.  
 - Configure the new token. Set an expiration time that meets your organization's needs. An expiration time of 60d fits most use cases.  
 - Copy/paste your token into your API client or save for use in curl requests.  
 - Set up API client (optional)  
  
When setting up an API client, such as Postman, specify the following parameters:  
 - {baseURL}: The base URL of the ACS API (https://admin.splunk.com).  
 - {stack}: The URL prefix of your Splunk Cloud deployment (e.g. csms-2io6tw-47150)   
 - {feature}: The feature to which IP allow list requests apply.  
 - {token}: The token generated by Splunk Cloud. See Generate an authentication token.  
  
When using the curl command, you must pass the above parameters with the ACS API request.  
  
  
### 2a. HEC - DMC API Commands
The DMC is the Distributed Management Console and provides a set of API commands.
  
  
Ensure the DMC API is available for use.  
```bash
curl -k -u admin:your_password https://CUSTOMER_NAME.splunkcloud.com:8089/services/dmc/info
```
If you get a response saying the DMC servive is ```enabled``` you can use the commands below.  
  
Create HEC Token. 
```bash
curl -k -u admin:your_password -X POST -H "Content-Type: application/json" https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http -d '{"name":"Anthony1", "description":"token created via REST", "index":"main", "sourcetype":"json_no_timestamp"}' 
```
  
List all HEC Tokens
```bash
curl -k -u admin:your_password https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http
```
  
List HEC Token by Name
```bash
curl -k -u admin:your_password https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http/Anthony1
```
  
Disable HEC Token
```bash
curl -k -u admin:your_password -H "Content-Type: application/json" https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http/Anthony1 -d '{"disabled":"true"}'
```
  
Enable HEC Token
```bash
curl -k -u admin:your_password -H "Content-Type: application/json" https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http/Anthony1 -d '{"disabled":"false"}'
```
  
Update HEC Token
```bash
curl -k -u admin:your_password -H "Content-Type: application/json" https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http/Anthony1 -d '{"description":"Updated Description"}'
```
  
Delete HEC Token
```bash
curl -k -u admin:your_password -X DELETE https://customer_splunk_url_name.splunkcloud.com:8089/services/dmc/config/inputs/__indexers/http/Anthony1
```
  
  
  
### 2b. HEC - ACS API Commands
Admin config service (ACS) commands to support operations on HEC via service.
  
Add HEC Token.  
```bash
curl --location --request POST 'admin.splunk.com/:stack/adminconfig/v1/inputs/http-event-collectors' \
--header 'Authorization: Bearer <token>' \
--data-raw '{
    “name” : “tokenname”,
    "defaultIndex": "idx",
    "defaultSource": "default_source",
    "defaultHost": "somehost.com",
    "defaultSourceType": "source_type",
    "disabled": false,
    "allowedIndexes": [
        "idx",
        "notidx"
    ]
}'
```
  
Get HEC Token.  
```bash
curl --location --request GET 'admin.splunk.com/:stack/adminconfig/v1/inputs/http-event-collectors' \
--header 'Authorization: Bearer <token>'
```
  
Get HEC Name.  
```bash
curl --location --request GET 'admin.splunk.com/:stack/adminconfig/v1/hec/newhectoken' \
--header 'Authorization: Bearer <token>'
```
  
Delete HEC Name.  
```bash
curl --location --request DELETE 'admin.splunk.com/:stack/adminconfig/v1/inputs/http-event-collectors/:hecname' \
--header 'Authorization: Bearer <token>' \
--data-raw '{}'
```
  
  
### 3. Configure IP allow lists for Splunk Cloud
Splunk Cloud IP allow lists control which IP addresses on your network have access to specified components (features) in your Splunk Cloud deployment. You can use the Splunk Cloud Admin Config Service (ACS) API to add or remove subnets from the allow list and manage access to features in your Splunk Cloud environment programmatically.  
  
3a. Determine IP allow list use case
The ACS API supports several common IP allow list use cases. In each use case, the IP allow list controls access to a particular Splunk Cloud feature. 
  
| Use Case	| Feature Type	| Port	| Description |
| ------------- |:------------:| ------------- |:------------:|
| Search head API access |	search-api |	8089 |	Grants access for customer subnets to Splunk search head api (applies to automated interfaces) |
| HEC access for ingestion |	hec |	443	| Allows customer's environment to send HTTP data to Splunk indexers. |
| Indexer ingestion |	s2s |	9997 |	Allows subnets that include UF or HF to send data to Splunk indexers. |
| SH UI access |	search-ui |	80/443	| Grant explicit access to search head UI in regulated customer environments. |
| IDM UI access |	idm-ui |	443 |	Grant explicit access to IDM UI in regulated customer environments. |
| IDM API |	idm-api |	8089 |	Grant access for add-ons that require an API. (Allows add-ons to send data to Splunk Cloud.) |
  
3b. View current IP Allow list.  
To view the full list of existing subnets for a particular IP allow list feature type, send an HTTP GET request to the following endpoint:  
```bash
{baseUrl}/{stack}/adminconfig/v1/access/{feature}/ipallowlists
```
For example, to view the full list of subnets for the s2s IP allow list feature type, send the following request:  
```bash
curl https://admin.splunk.com/{stack}/adminconfig/v1/access/s2s/ipallowlists
```
The request returns the current allow list subnets for the s2s feature type only. For example:  
  
```bash
{
  "subnets": [
     ": #.0.0.0/24",
     ": #.0.0.0/24",
     ": #.0.10.6/32"
  ]
}
```
  
  
[Back to the Lab Index](../README.md#get-shirt-hot-with-splunk)
  
